{% extends "base.html" %}

{% block title %}Predict - Smart Crop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/predict.css') }}">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="grid-container">
        <!-- Crop Facts Carousel -->
        <div class="grid-item">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Crop Facts</h5>
                </div>
                <div class="card-body p-0">
                    <div id="cropFactsCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for fact in crop_facts %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <div class="fact-card p-4">
                                    <h6 class="card-subtitle mb-2 text-muted">{{ fact.title }}</h6>
                                    <p class="card-text">{{ fact.description }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#cropFactsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#cropFactsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Card -->
        <div class="grid-item">
            <div class="card location-card">
                <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-geo-alt"></i> Location</span>
                        <button class="btn btn-light btn-sm" onclick="getLocation()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </h5>
                    <p id="location" class="card-text">Detecting location...</p>
                </div>
            </div>
        </div>

        <!-- Weather Card -->
        <div class="grid-item">
            <div class="card weather-card">
                <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-cloud-sun"></i> Weather</span>
                        <button class="btn btn-light btn-sm" onclick="getWeather()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </h5>
                    <p id="weather" class="card-text">Loading weather data...</p>
                </div>
            </div>
        </div>

        <!-- Prediction Form -->
        <div class="grid-item" style="grid-column: 1 / -1;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Crop Prediction</h5>
                </div>
                <div class="card-body">
                    <form id="predictionForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nitrogen" class="form-label">
                                        <i class="bi bi-moisture"></i> Nitrogen (N)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="nitrogen" name="nitrogen" required>
                                        <span class="input-group-text">mg/kg</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="phosphorus" class="form-label">
                                        <i class="bi bi-moisture"></i> Phosphorus (P)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="phosphorus" name="phosphorus" required>
                                        <span class="input-group-text">mg/kg</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="potassium" class="form-label">
                                        <i class="bi bi-moisture"></i> Potassium (K)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="potassium" name="potassium" required>
                                        <span class="input-group-text">mg/kg</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="ph" class="form-label">
                                        <i class="bi bi-water"></i> pH
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="ph" name="ph" required>
                                        <span class="input-group-text">pH</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="temperature" class="form-label">
                                        <i class="bi bi-thermometer-half"></i> Temperature
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="temperature" name="temperature" required>
                                        <span class="input-group-text">°C</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="humidity" class="form-label">
                                        <i class="bi bi-droplet-half"></i> Humidity
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="humidity" name="humidity" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="rainfall" class="form-label">
                                        <i class="bi bi-cloud-rain"></i> Rainfall
                                    </label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" id="rainfall" name="rainfall" required>
                                        <span class="input-group-text">mm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-search"></i> Predict Crop
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if prediction %}
        <!-- Prediction Results -->
        <div class="grid-item" style="grid-column: 1 / -1;">
            <div class="prediction-result">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-check-circle"></i> Prediction Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="card-subtitle mb-2 text-muted">Predicted Yield</h6>
                                <p class="display-6 text-success">{{ prediction.crop }} tons</p>
                                
                                {% if prediction.stats %}
                                <div class="yield-stats mt-3">
                                    <h6 class="text-muted">Historical Statistics</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Average Yield:</small>
                                            <p class="mb-2">{{ prediction.stats.average }} tons</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Trend:</small>
                                            <p class="mb-2">
                                                {% if prediction.stats.trend == 'up' %}
                                                <i class="bi bi-arrow-up-circle-fill text-success"></i> Above Average
                                                {% else %}
                                                <i class="bi bi-arrow-down-circle-fill text-danger"></i> Below Average
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Maximum:</small>
                                            <p class="mb-2">{{ prediction.stats.maximum }} tons</p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Minimum:</small>
                                            <p class="mb-2">{{ prediction.stats.minimum }} tons</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ prediction.confidence }}%" 
                                         aria-valuenow="{{ prediction.confidence }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ prediction.confidence }}% Confidence
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                {% if prediction.fertilizer_recommendation %}
                                <h6 class="card-subtitle mb-2 text-muted">Fertilizer Recommendation</h6>
                                <p class="card-text">{{ prediction.fertilizer_recommendation | nl2br }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Historical Analysis Section -->
        <div class="grid-item" style="grid-column: 1 / -1;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Historical Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="masonry-grid">
                        <!-- Yield Trend Graph -->
                        <div class="grid-item">
                            <div class="chart-container">
                                <h6 class="text-muted mb-3">Yield Trend</h6>
                                <div id="yieldTrendPlot" style="width: 100%; height: 400px;"></div>
                            </div>
                        </div>
                        
                        <!-- Parameter Impact Graph -->
                        <div class="grid-item">
                            <div class="chart-container">
                                <h6 class="text-muted mb-3">Parameter Impact Analysis</h6>
                                <div id="parameterImpactPlot" style="width: 100%; height: 400px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/predict.js') }}"></script>
<script src="{{ url_for('static', filename='js/plots.js') }}"></script>
<script>
    // Get location using browser's geolocation API
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function showPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        // Get location name using reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("location").innerHTML = data.display_name;
            })
            .catch(error => {
                document.getElementById("location").innerHTML = "Error getting location name";
            });

        // Get weather data
        getWeather(lat, lon);
    }

    function getWeather(lat, lon) {
        const apiKey = '53d81f3426cc1ee8748db205dc530348';
        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("temperature").value = data.main.temp;
                document.getElementById("humidity").value = data.main.humidity;
                document.getElementById("weather").innerHTML = `
                    <div class="d-flex align-items-center">
                        <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" alt="Weather icon">
                        <div class="ms-3">
                            <h6 class="mb-0">${data.weather[0].description}</h6>
                            <p class="mb-0">
                                Temperature: ${data.main.temp}°C<br>
                                Humidity: ${data.main.humidity}%
                            </p>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById("weather").innerHTML = "Error getting weather data";
            });
    }

    // Initialize location on page load
    window.onload = getLocation;

    {% if yield_trend_plot %}
    try {
        console.log("Initializing yield trend plot");
        const yieldTrendData = {{ yield_trend_plot | safe }};
        console.log("Yield trend data:", yieldTrendData);
        Plotly.newPlot('yieldTrendPlot', yieldTrendData.data, yieldTrendData.layout)
            .then(() => console.log("Yield trend plot created successfully"))
            .catch(error => console.error("Error creating yield trend plot:", error));
    } catch (error) {
        console.error("Error processing yield trend data:", error);
    }
    {% endif %}

    {% if parameter_impact_plot %}
    try {
        console.log("Initializing parameter impact plot");
        const parameterImpactData = {{ parameter_impact_plot | safe }};
        console.log("Parameter impact data:", parameterImpactData);
        Plotly.newPlot('parameterImpactPlot', parameterImpactData.data, parameterImpactData.layout)
            .then(() => console.log("Parameter impact plot created successfully"))
            .catch(error => console.error("Error creating parameter impact plot:", error));
    } catch (error) {
        console.error("Error processing parameter impact data:", error);
    }
    {% endif %}
</script>
{% endblock %}